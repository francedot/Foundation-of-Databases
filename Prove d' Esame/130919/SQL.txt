DROP TABLE CONTRIBUENTI;
DROP TABLE ENTRATE;
DROP TABLE IMPOSTE;

CREATE TABLE CONTRIBUENTI(

	CF CHAR(10) NOT NULL PRIMARY KEY,
	COMUNE VARCHAR(15) NOT NULL

);

CREATE TABLE ENTRATE(

	ANNO INT NOT NULL,
	COMUNE VARCHAR(15) NOT NULL,
	TOTALE FLOAT NOT NULL,
	
	PRIMARY KEY(ANNO, COMUNE)

);

CREATE TABLE IMPOSTE(

	ANNO INT NOT NULL,
	CF CHAR(10) NOT NULL REFERENCES CONTRIBUENTI,
	IMPONIBILE FLOAT NOT NULL,
	
	PRIMARY KEY(ANNO, CF)

);


-- 2.1) [2 p.] I comuni che nel 2012 hanno avuto tutti i loro contribuenti registrati in IMPOSTE

WITH CONT_NOT_IMP_2012(CF) AS(

	SELECT CF
	FROM CONTRIBUENTI
	EXCEPT
	SELECT CF
	FROM IMPOSTE
	WHERE ANNO = 2012

),

COMUNI_CONT_NOT_IN_IMP(COMUNE) AS(

	SELECT COMUNE
	FROM CONTRIBUENTI
	WHERE CF IN( SELECT * FROM CONT_NOT_IMP_2012 )
	
)

SELECT COMUNE
FROM CONTRIBUENTI
EXCEPT
SELECT COMUNE
FROM COMUNI_CONT_NOT_IN_IMP;

-- 2.2) [3 p.] I comuni che per almeno tre volte hanno incassato in un anno meno dell'anno precedente

--SELF-JOIN

-- CONTRIBUENTI(CF,Comune);

-- ENTRATE(Anno,Comune,Totale);

-- IMPOSTE(Anno,CF,Imponibile),
-- CF REFERENCES CONTRIBUENTI;
-- ogni anno i codici fiscali (CF) presenti in IMPOSTE sono un
-- sottoinsieme di quelli in CONTRIBUENTI

SELECT E1.COMUNE
FROM ENTRATE E1, ENTRATE E2
WHERE E1.COMUNE = E2.COMUNE
AND E1.ANNO = E2.ANNO + 1 -- deve essere l'anno successivo! altrimenti conteggio sbagliato!
AND E1.TOTALE < E2.TOTALE
GROUP BY E1.COMUNE
HAVING COUNT(*) >= 3;

SELECT ANNO, COUNT(COMUNE <> TOTALE)
FROM IMPOSTE
GROUP BY ANNO;

