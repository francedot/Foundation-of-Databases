-- CANTINE(CID,Regione);
-- VINI(CodV,Nome,CID,Anno,Punteggio),
-- CID REFERENCES CANTINE;
-- NEGOZI(IDNegozio,CodV,Prezzo,NumBottiglie),
-- CodV REFERENCES VINI;

DROP TABLE CANTINE;
DROP TABLE VINI;
DROP TABLE NEGOZI;

CREATE TABLE CANTINE(
	
	CID CHAR(2) NOT NULL PRIMARY KEY,
	REGIONE VARCHAR(15) NOT NULL
	
);

CREATE TABLE VINI(
	
	CODV CHAR(2) NOT NULL PRIMARY KEY,
	NOME VARCHAR(15) NOT NULL,
	CID CHAR(2) NOT NULL REFERENCES CANTINE,
	ANNO INT NOT NULL,
	PUNTEGGIO INT NOT NULL
	
);

CREATE TABLE NEGOZI(
	
	IDNEGOZIO CHAR(2) NOT NULL,
	CODV CHAR(2) NOT NULL REFERENCES VINI,
	PREZZO INT NOT NULL,
	NUMBOTTIGLIE INT NOT NULL,
	
	PRIMARY KEY(IDNEGOZIO, CODV)
	
); 

INSERT INTO CANTINE(CID, REGIONE)
VALUES('C1', 'Emilia Romagna'),
	  ('C2', 'Marche'),
	  ('C3', 'Veneto'),
	  ('C4', 'Emilia Romagna');
	  
INSERT INTO VINI(CODV,NOME,CID,ANNO,PUNTEGGIO)
VALUES('V1', 'Bastianich', 'C1', 2006, 10),
	  ('V2', 'Bastianich', 'C1', 20069, 9),
	  ('V3', 'Leopardi', 'C2', 2003, 4),
	  ('V4', 'Leopardi', 'C2', 2006, 9),
	  ('V5', 'Bonacci', 'C1', 2006, 9),
	  ('V6', 'Bonacciume', 'C1', 2009, 9),
	  ('V7', 'Maratta', 'C1', 2006, 9);

INSERT INTO NEGOZI(IDNEGOZIO,CODV,PREZZO,NUMBOTTIGLIE)
VALUES('N1', 'V1', 233, 13),
	  ('N1', 'V2', 233, 13),
	  ('N1', 'V5', 233, 13),
	  ('N1', 'V6', 233, 13),
	  ('N1', 'V7', 233, 13),
	  ('N2', 'V1', 22, 74),
	  ('N2', 'V3', 245, 85),
	  ('N4', 'V1', 233, 344),
	  ('N4', 'V5', 221, 54);


-- 2.1) [2 p.] I negozi che non hanno disponibilità maggiore di 10 bottiglie per nessun vino con
-- punteggio maggiore di 8

--CANTINE(CID,Regione);
-- VINI(CodV,Nome,CID,Anno,Punteggio),
-- CID REFERENCES CANTINE;
-- NEGOZI(IDNegozio,CodV,Prezzo,NumBottiglie),
-- CodV REFERENCES VINI;

SELECT *
FROM CANTINE C, VINI V, NEGOZI N
WHERE C.CID = V.CID
AND V.CODV = N.CODV;

SELECT DISTINCT IDNEGOZIO
FROM NEGOZI
EXCEPT
SELECT DISTINCT N.IDNEGOZIO
FROM NEGOZI N, VINI V
WHERE N.CODV = V.CODV
AND N.NUMBOTTIGLIE > 10
AND V.PUNTEGGIO > 8;

-- 2.2) [3 p.] Per ogni regione con almeno 3 vini con punteggio maggiore di 8, i negozi che ne hanno
-- almeno 10 bottiglie di ognuno

SELECT *
FROM CANTINE C, VINI V, NEGOZI N
WHERE C.CID = V.CID
AND V.CODV = N.CODV;

--REGIONI CON ALMENO 3 VINI CON PUNTEGGIO > 8
WITH REGIONI_LEAST3(REGIONE) AS(

	SELECT C.REGIONE
	FROM CANTINE C, VINI V
	WHERE C.CID = V.CID
	AND V.PUNTEGGIO > 8
	GROUP BY C.REGIONE
	HAVING COUNT(*) > 3
	
)
--NEGOZI CHE HANNO ALMENO 10 BOTTIGLIE DI OGNI VINO DELLA REGIONE
-- CHE SODDISFANO QUESTA PROPRIETA'

DIVIDENDO: NEGOZI, VINI
DIVISORE: VINI DELLA REGIONE CODV

--DIVIDENDO

SELECT N.IDNEGOZIO, N.CODV
FROM NEGOZI N;

--DIVISORE
SELECT V.CODV
FROM VINI V
WHERE V.REGIONE IN (SELECT * FROM REGIONI_LEAST3)

SELECT N1.IDNEGOZIO
FROM NEGOZI N1
WHERE NOT EXISTS(SELECT *
				 FROM VINI V
				 WHERE NOT EXISTS(SELECT *
				 				  FROM NEGOZI N2
								  WHERE N1.IDNEGOZIO = N2.IDNEGOZIO
								  AND V.CODV = N2.CODV));


SELECT *
FROM CANTINE C, VINI V, NEGOZI N
WHERE C.CID = V.CID
AND V.CODV = N.CODV
AND C.REGIONE IN (SELECT * FROM REGIONI_LEAST3)
GROUP BY N.IDNEGOZIO, 








PROP COMUNE: CHE HANNO ALMENO 10 BOTTIGLIE DI OGNUNO (TUTTI)
DIVIDENDO: (NEGOZI, VINI)
DIVISORE: VINI dove vini sono i codv dei negozi che ne hanno numero > 10











