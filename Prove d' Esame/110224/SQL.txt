DROP TABLE CLIENTI;
DROP TABLE ELETTRODOMESTICI;
DROP TABLE RIPARAZIONI;

CREATE TABLE CLIENTI (
	CODC CHAR(5) NOT NULL PRIMARY KEY,
	NOME VARCHAR(30) NOT NULL,
	COGNOME VARCHAR(30) NOT NULL,
	COMUNE VARCHAR(30) NOT NULL	);

CREATE TABLE ELETTRODOMESTICI (
	CODE CHAR(5) NOT NULL PRIMARY KEY,
	CODCLIENTE CHAR(5) NOT NULL REFERENCES CLIENTI,
	MARCA VARCHAR(20) NOT NULL,
	MODELLO VARCHAR(20) NOT NULL,
	TIPOLOGIA VARCHAR(20) NOT NULL	);

CREATE TABLE RIPARAZIONI (
	CODRIP CHAR(5) NOT NULL PRIMARY KEY,
	CODE CHAR(5) NOT NULL REFERENCES ELETTRODOMESTICI,
	DIAGNOSI VARCHAR(30) NOT NULL,
	DATACONSEGNA DATE NOT NULL,
	DATARITIRO DATE,
	IMPORTO INT		);

INSERT INTO CLIENTI VALUES
('C0001','Marco','Rossi','Bologna'),
('C0002','Luca','Verdi','Bologna'),
('C0003','Massimo','Bianchi','Cesena'),
('C0004','Luca','Verdi','Imola'),
('C0005','Anna','Neri','Bologna');

INSERT INTO ELETTRODOMESTICI VALUES
('EL123','C0001','Revooh','LAV24','lavatrice'),
('EL234','C0001','Revooh','PHN05','asciugacapelli'),
('EL345','C0002','Revooh','LAV28','lavatrice'),
--('EL345','C0002','Revooh','PHN05','asciugacapelli'),
('EL456','C0002','Eleim','TST04','tostapane'),
('EL567','C0003','Tisedni','LAV01','lavatrice');

INSERT INTO RIPARAZIONI VALUES
('Rab01','EL123','perdita acqua','12/01/2011','28/01/2011',60),
('Rab02','EL123','filtro sporco','30/01/2011','02/02/2011',60),
('Rab03','EL234','resistenza bruciata','25/01/2011','04/02/2011',40),
('Rab04','EL345','perdita acqua','12/12/2010','15/01/2011',90),
('Rab05','EL345','guarnizione difettosa','28/01/2011',NULL,NULL),
('Rab06','EL456','fa fumo','15/02/2011','24/02/2011',20),
('Rab07','EL567','non sciacqua','11/01/2011','24/01/2011',80);

SELECT * FROM CLIENTI;
SELECT * FROM ELETTRODOMESTICI;
SELECT * FROM RIPARAZIONI;

-- CLIENTI(CodC,Nome,Cognome,Comune);

-- ELETTRODOMESTICI(CodE,CodCliente,Marca,Modello,Tipologia),
-- CodCliente REFERENCES Clienti;

-- RIPARAZIONI(CodRip,CodE,Diagnosi,DataConsegna,DataRitiro*,Importo*),
-- CodE REFERENCES ELETTRODOMESTICI;
-- Importo e' un intero
-- DataRitiro e Importo hanno valore nullo per le riparazioni in corso

-- 2.1) [2 p.] Per ogni cliente di Bologna, l'importo totale speso per riparazioni di durata superiore ai 7
-- giorni

SELECT *
FROM CLIENTI C, ELETTRODOMESTICI E, RIPARAZIONI R
WHERE C.CODC = E.CODCLIENTE AND E.CODE = R.CODE;

--SU NULLA DATARITIRO NULLO ANCHE IMPORTO GESTITO DA SCHEMA?

SELECT C.CODC, C.NOME, C.COGNOME, SUM(R.IMPORTO) AS IMPORTO_TOTALE
FROM CLIENTI C, ELETTRODOMESTICI E, RIPARAZIONI R
WHERE C.CODC = E.CODCLIENTE AND E.CODE = R.CODE
AND UPPER(C.COMUNE) = 'BOLOGNA'
AND DATARITIRO IS NOT NULL -->VERIFICARE SE SUPERFLUA
AND DAYS(R.DATARITIRO) - DAYS(R.DATACONSEGNA) > 7
GROUP BY C.CODC, C.NOME, C.COGNOME;


--SOL PROF

SELECT C.CodC, SUM(R.Importo) AS SpesaTotale
FROM CLIENTI C, ELETTRODOMESTICI E, RIPARAZIONI R
WHERE C.CodC = E.CodCliente
AND E.CodE = R.CodE
AND DAYS(R.DataRitiro) - DAYS(R.DataConsegna) > 7
AND C.Comune = 'Bologna'
GROUP BY C.CodC;

--C0005 Anna Neri non compare in quanto non ha richiesto alcuna riparazione pertanto si da per scontato ImportoTotale = 0

-- 2.2) [3 p.] Per ogni marca di lavatrici, l'importo pi√π frequentemente pagato e le diagnosi ad esso
-- associate

WITH MARCA_DIAGNOSI_IMPORTO(MARCA, DIAGNOSI, IMPORTO) AS(

	SELECT E.MARCA, R.DIAGNOSI, R.IMPORTO
	FROM ELETTRODOMESTICI E, RIPARAZIONI R
	WHERE E.CODE = R.CODE
	AND R.IMPORTO IS NOT NULL
	AND UPPER(E.TIPOLOGIA) = 'LAVATRICE'
	GROUP BY E.MARCA, R.DIAGNOSI, R.IMPORTO
	
),

MARCA_IMPORTO_FREQIMP(MARCA, IMPORTO, FREQUENZAIMPORTO) AS(

	SELECT MARCA, IMPORTO, COUNT(*) AS FREQUENZAIMPORTO
	FROM MARCA_DIAGNOSI_IMPORTO
	GROUP BY MARCA, IMPORTO

),

MARCA_IMPORTOPIUFREQ(MARCA, IMPORTOPIUFREQ) AS(

	SELECT M1.MARCA, M1.IMPORTO
	FROM MARCA_IMPORTO_FREQIMP M1
	WHERE FREQUENZAIMPORTO = (SELECT MAX(FREQUENZAIMPORTO)
							  FROM MARCA_IMPORTO_FREQIMP M2
							  WHERE M1.MARCA = M2.MARCA)

)

SELECT M2.MARCA, M2.IMPORTO, M2.DIAGNOSI
FROM MARCA_IMPORTOPIUFREQ M1, MARCA_DIAGNOSI_IMPORTO M2
WHERE M1.MARCA = M2.MARCA AND M1.IMPORTOPIUFREQ = M2.IMPORTO;

--PROF

WITH FREQIMPORTI(Marca,Importo,NVolte) AS (

	SELECT E.Marca, R.Importo, COUNT(*)
	FROM ELETTRODOMESTICI E, RIPARAZIONI R
	WHERE E.CodE = R.CodE
	AND E.Tipologia = 'lavatrice'
	AND R.Importo IS NOT NULL
	GROUP BY E.Marca, R.Importo

),
	
MAXFREQ(Marca,Importo) AS (

	SELECT F.Marca, F.Importo
	FROM FREQIMPORTI F
	WHERE F.NVolte = (SELECT MAX(F1.NVolte)
					  FROM FREQIMPORTI F1
					  WHERE F1.Marca = F.Marca)

)

SELECT DISTINCT M.Marca, M.Importo, R.Diagnosi
FROM MAXFREQ M, ELETTRODOMESTICI E, RIPARAZIONI R
WHERE M.Marca = E.Marca
AND E.CodE = R.CodE
AND E.Tipologia = 'lavatrice'
AND M.Importo = R.Importo;



