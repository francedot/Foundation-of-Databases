SELECT * FROM MEDICI;
SELECT * FROM REPARTI;
SELECT * FROM RICOVERI;

SELECT *
FROM REPARTI R JOIN MEDICI M ON (R.IDDIRETTORE = M.MID)

--2.1) [2 p.] I nomi dei reparti che nel 2014 non hanno assunto nessun medico con meno
--di 35 anni (alla data dell’assunzione)

SELECT NOME AS REPARTO
FROM REPARTI
EXCEPT
SELECT REPARTO
FROM MEDICI
WHERE YEAR(DATAASSUNZIONE) = 2014
AND YEAR(DATANASCITA) > 1979;

SELECT *
FROM REPARTI R, MEDICI M
WHERE R.IDDIRETTORE = M.MID;

-- MEDICI(MID,Nome,DataNascita,DataAssunzione,Reparto),
-- Reparto REFERENCES REPARTI;

-- REPARTI(Nome,IDDirettore*),
-- IDDirettore REFERENCES MEDICI;

-- RICOVERI(RID,NomePaziente,Motivo,Reparto,Da,A*),
-- Reparto REFERENCES REPARTI;

-- 2.2) [3 p.] Per ogni fascia di età (20-29, 30-39, ecc.), il reparto con il maggior numero di medici,
-- escludendo dal conteggio i direttori

SELECT DISTINCT 2014-YEAR(DATANASCITA)
FROM MEDICI;		 
					 
--VISTA MEDICI_NOT_DIR
WITH MEDICI_NOT_DIR(MID,NOME,DATANASCITA,DATAASSUNZIONE,REPARTO) AS(

	SELECT *
	FROM MEDICI
	EXCEPT
	SELECT M.*
	FROM MEDICI M JOIN REPARTI R ON (M.MID = R.IDDIRETTORE)
	
),

--VISTA FASCIA_REP_NUMMEDICI
FASCIA_REP_NUMMEDICI(FASCIA, REPARTO, NUMMEDICI) AS (

	SELECT ((2014-YEAR(M.DATANASCITA))/10) CONCAT '0-' CONCAT ((2014-YEAR(M.DATANASCITA))/10) 
		CONCAT '9', M.REPARTO, COUNT(*)
	FROM MEDICI_NOT_DIR M
	GROUP BY ((2014-YEAR(M.DATANASCITA))/10), M.REPARTO
	
)

SELECT F1.FASCIA, F1.REPARTO
FROM FASCIA_REP_NUMMEDICI F1
WHERE F1.NUMMEDICI >= (SELECT MAX(F2.NUMMEDICI)
					  FROM FASCIA_REP_NUMMEDICI F2
					  WHERE F1.FASCIA = F2.FASCIA);


--VISTA MEDICI_NOT_DIR
WITH MEDICI_NOT_DIR(MID,NOME,DATANASCITA,DATAASSUNZIONE,REPARTO) AS(

	SELECT *
	FROM MEDICI
	EXCEPT
	SELECT M.*
	FROM MEDICI M JOIN REPARTI R ON (M.MID = R.IDDIRETTORE)
	
),

--VISTA FASCIA_REP_NUMMEDICI
FASCIA_REP_NUMMEDICI(FASCIA, REPARTO, NUMMEDICI) AS (

	SELECT ((2014-YEAR(M.DATANASCITA))/10) CONCAT '0-' CONCAT ((2014-YEAR(M.DATANASCITA))/10) 
		CONCAT '9', M.REPARTO, COUNT(*)
	FROM MEDICI_NOT_DIR M
	GROUP BY ((2014-YEAR(M.DATANASCITA))/10), M.REPARTO
	
)

SELECT*
FROM FASCIA_REP_NUMMEDICI F1










