
DROP TABLE SCARPE;
DROP TABLE COMBINAZIONI;
DROP TABLE VENDITE;

CREATE TABLE SCARPE (

	SID CHAR(4) NOT NULL PRIMARY KEY,
	MARCA VARCHAR(10) NOT NULL,
	MODELLO VARCHAR(10) NOT NULL

);

CREATE TABLE COMBINAZIONI (

	CID CHAR(4) NOT NULL PRIMARY KEY,
	SID CHAR(4) NOT NULL REFERENCES SCARPE,
	TAGLIA INT NOT NULL,
	COLORE VARCHAR(10),
	PREZZO DEC(6, 2) NOT NULL,
	NUMDISPONIBILI INT NOT NULL

);

CREATE TABLE VENDITE (

	CID CHAR(4) NOT NULL REFERENCES COMBINAZIONI,
	DATA DATE NOT NULL,
	NUMERO INT NOT NULL,
	
	PRIMARY KEY(CID, DATA)
	
);


-- 2.1) [2 p.] Per ogni combinazione, l'incasso totale del 2014

-- SCARPE(SID,Marca,Modello);

-- COMBINAZIONI(CID,SID,Taglia,Colore,Prezzo,NumDisponibili),
-- SID REFERENCES SCARPE;

-- VENDITE(CID,Data,Numero),
-- CID REFERENCES COMBINAZIONI;

WITH CID_PREZZO_NUMVENDITE(CID, PREZZO, NUMVENDITE) AS(

	SELECT C.CID, C.PREZZO, SUM(V.NUMERO)
	FROM COMBINAZIONI C JOIN VENDITE V ON(C.CID = V.CID)
	WHERE YEAR(V.DATA) = 2014
	GROUP BY C.CID, C.PREZZO

)

SELECT CID, (PREZZO * NUMVENDITE) AS INCASSO_2014
FROM CID_PREZZO_NUMVENDITE;

-- 2.2) [3 p.] Per ogni scarpa di modello 'sneaker', la combinazione (taglia e colore) più venduta nel
-- 2014

WITH TAGLIA_COLORE_NUMVENDITE(SID, CID, TAGLIA, COLORE, NUMVENDITE) AS(

	SELECT C.SID C.CID, C.TAGLIA, C.COLORE, SUM(V.NUMERO)
	FROM SCARPE S, COMBINAZIONI C, VENDITE V
	WHERE S.SID = C.SID AND C.CID = V.CID
	AND UPPER(S.MODELLO) LIKE 'SNEAKER'
	AND YEAR(V.DATA) = 2014
	GROUP BY C.SID, C.CID, C.TAGLIA, C.COLORE

)

SELECT T.SID, T.TAGLIA, T.COLORE
FROM TAGLIA_COLORE_NUMVENDITE T
WHERE T.NUMVENDITE = (SELECT MAX(NUMVENDITE)
					  FROM TAGLIA_COLORE_NUMVENDITE T1
					  WHERE T1.SID = T.SID);




























