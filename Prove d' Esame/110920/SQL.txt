DROP TABLE FURGONI;
DROP TABLE TRASLOCHI;
DROP TABLE CARICHI;

CREATE TABLE FURGONI (
	TARGA CHAR(7) NOT NULL PRIMARY KEY,
	CAPIENZA INT NOT NULL CHECK (CAPIENZA > 0)	);

CREATE TABLE TRASLOCHI (
	CODT CHAR(5) NOT NULL PRIMARY KEY,
	DA VARCHAR(30) NOT NULL,
	A VARCHAR(30) NOT NULL,
	PREZZO INT NOT NULL CHECK (PREZZO > 0),
	DATA DATE NOT NULL,
	IDCLIENTE CHAR(5) NOT NULL	);

CREATE TABLE CARICHI (
	TARGA CHAR(7) NOT NULL REFERENCES FURGONI,
	CODT CHAR(5) NOT NULL REFERENCES TRASLOCHI,
	PERCCARICO INT NOT NULL CHECK (PERCCARICO BETWEEN 1 AND 100)    );

INSERT INTO FURGONI VALUES
('BC001DE',20),
('BC015HJ',40),
('CD417EL',60),
('EA101RJ',60);

INSERT INTO TRASLOCHI VALUES
('T0123','Bologna','Milano',2500,'26/03/2010','C1225'),
('T0124','Bologna','Milano',1500,'01/04/2010','C1234');

INSERT INTO CARICHI VALUES
('CD417EL','T0123',80),
('EA101RJ','T0123',60),
('EA101RJ','T0124',70);

SELECT * FROM CARICHI;
SELECT * FROM FURGONI;
SELECT * FROM TRASLOCHI;

-- 2.1) [2 p.] Per ogni coppia "Da, A", il volume totale traslocato nel 2010

SELECT *
FROM CARICHI C, FURGONI F, TRASLOCHI T
WHERE C.CODT = T.CODT AND F.TARGA = C.TARGA;


SELECT T.DA, T.A, SUM(F.CAPIENZA * C.PERCCARICO / 100) AS VOLUME
FROM CARICHI C, FURGONI F, TRASLOCHI T
WHERE C.CODT = T.CODT AND F.TARGA = C.TARGA
GROUP BY T.DA, T.A;

--2.2) [3 p.] Per ogni valore di capienza il furgone che, in media, è stato maggiormente caricato
-- LA MEDIA SI RIFERISCE ALLA PERCENTUALE DI CARICO E NON AL CARCICO TOTALE!
--SERVE SOLO FURGONI E CARICHI

WITH CAP_TARGA_PERC(CAPIENZA, TARGA, PERCCARICO) AS(

	SELECT F.CAPIENZA, C.TARGA, C.PERCCARICO
	FROM CARICHI C, FURGONI F
	WHERE F.TARGA = C.TARGA
	GROUP BY F.CAPIENZA, C.TARGA, C.PERCCARICO

),

CAP_TARGA_PERCMAX(CAPIENZA, TARGA, AVG_PERCCARICO) AS(

	SELECT CAPIENZA, TARGA, AVG(PERCCARICO / 1.0)
	FROM CAP_TARGA_PERC
	GROUP BY CAPIENZA, TARGA

)

SELECT C1.CAPIENZA, C1.TARGA
FROM CAP_TARGA_PERCMAX C1
WHERE C1.AVG_PERCCARICO = (SELECT MAX(C2.AVG_PERCCARICO) FROM CAP_TARGA_PERCMAX C2);




















